<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>KamaLasim â€” ×›××” ×œ×©×™×</title>

  <!-- Modern Hebrew UI font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- â€œHandwritten-ishâ€ feel: we simulate with styling (Hebrew handwriting fonts are rare on Google Fonts) -->
  <!-- You can later swap to any Hebrew handwriting font if you have one. -->

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icon-192.png">

  <!-- html2canvas for image sharing -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#070b14;
      --card:#0b1220;
      --text:#e9eeff;
      --muted:#a9b5d6;
      --accent:#7c5cff;
      --accent2:#34d399;
      --danger:#fb7185;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);

      /* Cheque paper palette (photo-inspired) */
      --paper1:#cfeff0;
      --paper2:#bfe6e8;
      --ink:#0a2a66;     /* â€œpen blueâ€ */
      --paperLine: rgba(11,42,46,.35);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Heebo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 500px at 100% 10%, rgba(52,211,153,.20), transparent 55%),
        radial-gradient(800px 500px at 0% 90%, rgba(251,113,133,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: 16px 14px 24px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-top: 6px;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand h1{ margin:0; font-size: 26px; letter-spacing: .2px; line-height: 1.15; }
    .brand p{ margin:0; color:var(--muted); font-size: 14px; line-height:1.35; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      font-weight:600;
      font-size: 13px;
      color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(124,92,255,.18);
    }

    /* Progress */
    .progress{
      margin: 14px 0 10px;
      padding: 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
    }
    .progressRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .seg{
      flex:1; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      overflow:hidden; position:relative;
    }
    .seg > i{
      position:absolute; inset:0;
      transform: translateX(100%);
      background: linear-gradient(90deg, rgba(124,92,255,.0), rgba(124,92,255,.85));
      border-radius:999px;
      transition: transform .5s cubic-bezier(.2,.9,.2,1);
    }
    .seg.done > i{ transform: translateX(0); }

    .progressMeta{
      display:flex; align-items:center; justify-content:space-between;
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Step cards */
    .stepCard{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 10px 0;
    }
    .stepTitle{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .stepTitle h2{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .stepTitle small{ color: var(--muted); font-weight:600; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .option{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: 16px;
      padding: 12px 12px;
      text-align:center;
      font-weight:800;
      font-size: 14px;
      color: var(--text);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      transition: transform .16s ease, border-color .2s ease, background .2s ease;
    }
    .option:active{ transform: scale(.98); }
    .option:hover{ border-color: rgba(255,255,255,.18); }
    .option.selected{
      border-color: rgba(124,92,255,.65);
      background: linear-gradient(180deg, rgba(124,92,255,.20), rgba(255,255,255,.02));
      box-shadow: 0 10px 28px rgba(124,92,255,.20);
      animation: pop .22s ease-out;
    }
    @keyframes pop{
      0%{ transform: scale(.98); }
      100%{ transform: scale(1); }
    }

    /* Bottom action bar */
    .bar{ position: sticky; bottom: 10px; z-index: 5; margin-top: 14px; }
    .barInner{
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(11,18,32,.82);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .preview{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .preview .label{ color: var(--muted); font-size: 12px; }
    .preview .value{ font-weight:900; font-size: 18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btn{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:900;
      font-size: 14px;
      cursor:pointer;
      color: #081021;
      background: linear-gradient(180deg, rgba(124,92,255,1), rgba(124,92,255,.78));
      box-shadow: 0 12px 30px rgba(124,92,255,.30);
      transition: transform .16s ease, filter .2s ease, opacity .2s ease;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.98); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; filter:saturate(.5); box-shadow:none; }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      color: var(--text);
      box-shadow:none;
      border:1px solid var(--line);
      font-weight:800;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(251,113,133,1), rgba(251,113,133,.78));
      box-shadow: 0 12px 30px rgba(251,113,133,.22);
      color:#17060a;
    }

    /* Result modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
      padding: 16px 14px;
    }
    .overlay.show{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      animation: fadeIn .2s ease-out;
    }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }

    .sheet{
      width: min(520px, 100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,18,32,.96), rgba(7,11,20,.96));
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
      transform: translateY(18px);
      animation: sheetUp .28s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes sheetUp{ to{ transform: translateY(0); } }

    .sheetHeader{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .sheetHeader .title{ display:flex; flex-direction:column; gap:2px; }
    .sheetHeader .title b{ font-size: 16px; }
    .sheetHeader .title span{ color: var(--muted); font-size: 12px; }

    .close{
      width: 40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .close:active{ transform: scale(.98); }

    .checkWrap{ padding: 14px; }

    /* ====== ISRAELI CHEQUE (photo-inspired) ====== */
    .check.ilCheque{
      position:relative;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.16);
      background: linear-gradient(180deg, var(--paper1), var(--paper2));
      color: #0b2a2e;
      box-shadow: 0 18px 60px rgba(0,0,0,.40);
      overflow:hidden;

      /* Print-in animation */
      transform: translateY(18px);
      opacity: 0;
      animation: printIn .45s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes printIn{
      to{ transform: translateY(0); opacity:1; }
    }

    .ilWatermark{
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(circle at 80% 40%, rgba(255,255,255,.22), transparent 60%),
        repeating-linear-gradient(45deg, rgba(0,0,0,.02) 0 2px, transparent 2px 10px);
      opacity:.6;
      pointer-events:none;
    }

    .ilContent{ position:relative; z-index:1; padding: 12px 12px 0; }

    .ilTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px 6px;
    }
    .ilBankTitle{ font-weight:900; font-size: 18px; letter-spacing:.2px; }
    .ilBankSub{ font-weight:800; font-size: 12px; opacity:.75; }
    .ilOnlyStamp{
      display:inline-block;
      font-weight:900;
      font-size: 12px;
      padding: 6px 10px;
      border: 2px solid rgba(11,42,46,.45);
      border-radius: 999px;
      background: rgba(255,255,255,.35);
    }

    .ilBody{
      padding: 0 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .ilRow{ display:flex; align-items:center; gap: 10px; }
    .ilLabel{
      font-weight:900;
      font-size: 11px;
      opacity:.82;
      white-space:nowrap;
    }
    .ilLabel.en{ direction:ltr; }
    .ilLabel.he{ font-size: 12px; }
    .ilLabel.heSmall{ font-size: 11px; opacity:.75; }

    .ilLine{
      flex:1;
      min-width: 0;
      border-bottom: 2px solid var(--paperLine);
      padding: 6px 6px 7px;
    }

    /* Handwriting look */
    .hand{
      color: var(--ink);
      font-weight:900;
      letter-spacing:.15px;
      display:inline-block;
      transform: rotate(-0.35deg);
      text-shadow:
        0.2px 0.2px 0 rgba(10,42,102,.10),
        0.6px 0.6px 0 rgba(10,42,102,.06);
    }
    .hand.small{ font-size: 15px; }
    .hand.big{ font-size: 20px; }

    /* â€œWritten by penâ€ animation
       We reveal the text by sliding a cover from right->left and moving a small pen tip.
       Works great for Hebrew RTL fields.
    */
    .write{
      position:relative;
      display:inline-block;
      padding-inline: 2px;
    }
    .write::after{
      content:"";
      position:absolute;
      inset:-2px -2px -2px -2px;
      background: linear-gradient(180deg, var(--paper1), var(--paper2));
      border-radius: 6px;
      transform: translateX(0%);
      opacity:1;
      pointer-events:none;
    }
    .write::before{
      content:"";
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #0b2a2e;
      box-shadow: 0 0 0 4px rgba(11,42,46,.12);
      top: 55%;
      transform: translate(0,-50%);
      right: -2px;
      opacity:0;
      pointer-events:none;
    }

    /* When writing starts */
    .doWrite .write::after{
      animation: revealInk 700ms cubic-bezier(.2,.9,.2,1) forwards;
    }
    .doWrite .write::before{
      opacity:1;
      animation: penMove 700ms cubic-bezier(.2,.9,.2,1) forwards;
    }

    /* Stagger different fields */
    .doWrite #w-recipient::after,
    .doWrite #w-recipient::before{ animation-delay: 120ms; }
    .doWrite #w-words::after,
    .doWrite #w-words::before{ animation-delay: 320ms; }
    .doWrite #w-amount::after,
    .doWrite #w-amount::before{ animation-delay: 520ms; }

    @keyframes revealInk{
      from{ transform: translateX(0%); }
      to{ transform: translateX(-110%); } /* move cover away to the LEFT */
    }
    @keyframes penMove{
      from{ right: -2px; }
      to{ right: calc(100% + 8px); } /* pen tip moves left across the text */
    }

    /* Amount box on the right (like photo) */
    .ilWords{ align-items:flex-end; }
    .ilAmountBox{
      width: 170px;
      border: 2px solid rgba(11,42,46,.45);
      border-radius: 10px;
      background: rgba(255,255,255,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 10px;
      gap: 8px;
      direction: rtl;
    }
    .ilAmountBoxLabel{ font-weight:900; font-size: 14px; opacity:.8; }
    .ilAmountBoxValue{ font-size: 22px; }

    /* Signature + Date */
    .ilBottomRow{ justify-content:space-between; gap: 16px; }
    .ilSig{ flex: 1.2; }
    .ilSigLine{
      height: 22px;
      border-bottom: 3px solid rgba(11,42,46,.40);
      margin: 6px 0 2px;
    }

    .ilDate{
      flex: .9;
      direction: ltr;
      text-align:left;
    }
    .ilDateBoxes{
      display:flex;
      align-items:center;
      gap: 6px;
      margin: 6px 0 2px;
    }
    .ilDateBox{
      border: 2px solid rgba(11,42,46,.35);
      border-radius: 8px;
      padding: 6px 8px;
      background: rgba(255,255,255,.30);
      font-weight:900;
      font-size: 12px;
      min-width: 94px;
      text-align:center;
      color: rgba(11,42,46,.85);
    }

    /* Approved stamp */
    .stamp{
      position:absolute;
      left: 16px;
      top: 50%;
      transform: rotate(-12deg) scale(.7);
      opacity: 0;
      border: 3px solid rgba(220,38,38,.85);
      color: rgba(220,38,38,.92);
      padding: 8px 12px;
      border-radius: 10px;
      font-weight:900;
      letter-spacing: .8px;
      background: rgba(220,38,38,.08);
      mix-blend-mode: multiply;
      animation: stamp 520ms cubic-bezier(.2,.9,.2,1) 680ms forwards;
      z-index: 2;
    }
    @keyframes stamp{
      0%{ opacity:0; transform: rotate(-12deg) scale(.55); }
      60%{ opacity:1; transform: rotate(-12deg) scale(1.06); }
      100%{ opacity:1; transform: rotate(-12deg) scale(1); }
    }

    /* MICR strip */
    .ilMicrStrip{
      margin-top: 10px;
      background: rgba(0,0,0,.08);
      border-top: 1px solid rgba(0,0,0,.10);
      padding: 10px 12px 12px;
      border-radius: 0 0 12px 12px;
    }
    .ilMicrLabels{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 10px;
      font-weight:900;
      opacity:.7;
      direction:ltr;
      color: rgba(0,0,0,.65);
    }
    .ilMicrLine{
      margin-top: 6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      direction:ltr;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      letter-spacing: 1.4px;
      color: rgba(0,0,0,.78);
    }
    .ilMicrInk{ opacity:.65; }

    /* Quip + actions */
    .quip{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(233,238,255,.88);
      font-weight:700;
      line-height:1.5;
    }

    .sheetActions{
      display:flex;
      gap: 10px;
      padding: 14px;
      border-top:1px solid var(--line);
      flex-wrap:wrap;
    }
    .sheetActions .btn{
      flex:1;
      min-width: 120px;
      justify-content:center;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    @media (max-width: 390px){
      .ilAmountBox{ width: 150px; }
      .ilAmountBoxValue{ font-size: 20px; }
      .hand.big{ font-size: 18px; }
      .ilDateBox{ min-width: 84px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <h1>×›××” ×œ×©×™× ğŸ’¸</h1>
        <p>××—×©×‘×•×Ÿ ×™×©×¨××œ×™ ×§×œ×™×œ ×©××¦×™×¢ ×¡×›×•× ×”×’×™×•× ×™ (×‘×¢×¨×š). ×‘×•× × ×¡×’×•×¨ ××ª ×”×¤×™× ×”.</p>
      </div>
      <div class="chip" title="PWA-ready">
        <span class="dot"></span>
        <span>Mobile â€¢ PWA</span>
      </div>
    </header>

    <section class="progress" aria-label="Progress">
      <div class="progressRow">
        <div class="seg" id="seg1"><i></i></div>
        <div class="seg" id="seg2"><i></i></div>
        <div class="seg" id="seg3"><i></i></div>
        <div class="seg" id="seg4"><i></i></div>
      </div>
      <div class="progressMeta">
        <span id="stepHint">×©×œ×‘ 1 ××ª×•×š 4</span>
        <span id="readyHint">×‘×—×¨/×™ ×›×“×™ ×œ×”×ª×§×“×</span>
      </div>
    </section>

    <!-- Steps -->
    <section class="stepCard" id="step1Card">
      <div class="stepTitle">
        <h2>×©×œ×‘ 1 â€” ×§×¨×‘×”</h2>
        <small>××” ×”×™×—×¡×™×?</small>
      </div>
      <div class="grid" id="closenessOptions"></div>
    </section>

    <section class="stepCard" id="step2Card">
      <div class="stepTitle">
        <h2>×©×œ×‘ 2 â€” ×¡×•×’ ××™×¨×•×¢</h2>
        <small>××” ×—×•×’×’×™×?</small>
      </div>
      <div class="grid" id="eventOptions"></div>
    </section>

    <section class="stepCard" id="step3Card">
      <div class="stepTitle">
        <h2>×©×œ×‘ 3 â€” ××§×•× ×”××™×¨×•×¢</h2>
        <small>××™×¤×” ×–×” ×§×•×¨×”?</small>
      </div>
      <div class="grid" id="locationOptions"></div>
    </section>

    <section class="stepCard" id="step4Card">
      <div class="stepTitle">
        <h2>×©×œ×‘ 4 â€” ×›××” ××ª×</h2>
        <small>××™ ××’×™×¢?</small>
      </div>
      <div class="grid" id="attendeesOptions"></div>
    </section>

    <!-- Bottom bar -->
    <div class="bar" role="region" aria-label="Actions">
      <div class="barInner">
        <div class="preview">
          <div class="label">×”×¦×¢×” (×‘×¨×’×¢ ×©×™×© ×”×›×œ):</div>
          <div class="value" id="previewValue">â‚ªâ€”</div>
        </div>
        <button class="btn" id="calcBtn" disabled>×—×©×‘</button>
      </div>
    </div>
  </div>

  <!-- Result overlay -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Result">
      <div class="sheetHeader">
        <div class="title">
          <b>×”×¦×³×§ ×›×‘×¨ ×‘×“×¨×š</b>
          <span>××¤×©×¨ ×œ×©×ª×£, ×œ×¨× ×“×•××™×™×–×¨, ××• ×œ×—×©×‘ ××—×“×©</span>
        </div>
        <button class="close" id="closeOverlay" aria-label="Close">âœ•</button>
      </div>

      <div class="checkWrap">
        <!-- CHEQUE CARD -->
        <div class="check ilCheque" id="checkCard">
          <div class="ilWatermark" aria-hidden="true"></div>

          <div class="ilTop">
            <div class="ilBank">
              <div class="ilBankTitle">××“×™× ×ª ×™×©×¨××œ</div>
              <div class="ilBankSub">××“××” ×¦×³×§ ×™×©×¨××œ×™ (×œ×›×™×£)</div>
            </div>
            <div class="ilOnly">
              <span class="ilOnlyStamp">×œ××•×˜×‘ ×‘×œ×‘×“</span>
            </div>
          </div>

          <div class="ilBody" id="chequeBody">
            <!-- Pay to -->
            <div class="ilRow ilPayTo">
              <div class="ilLabel en">PAY TO</div>
              <div class="ilLine">
                <span class="hand big write" id="w-recipient"><span id="recipientText">â€”</span></span>
              </div>
              <div class="ilLabel he">×©×œ××• ×œ</div>
            </div>

            <!-- Amount words + amount box -->
            <div class="ilRow ilWords">
              <div class="ilLabel heSmall">×¡×›×•× ×‘××™×œ×™×</div>
              <div class="ilLine">
                <span class="hand small write" id="w-words"><span id="amountWords">â€”</span></span>
              </div>

              <div class="ilAmountBox">
                <div class="ilAmountBoxLabel">â‚ª</div>
                <div class="ilAmountBoxValue">
                  <span class="hand big write" id="w-amount"><span id="amountText">â‚ªâ€”</span></span>
                </div>
              </div>
            </div>

            <!-- Signature + Date -->
            <div class="ilRow ilBottomRow">
              <div class="ilSig">
                <div class="ilLabel en">SIGNATURE</div>
                <div class="ilSigLine"></div>
                <div class="ilLabel heSmall">×—×ª×™××”</div>
              </div>

              <div class="ilDate">
                <div class="ilLabel en">DATE</div>
                <div class="ilDateBoxes">
                  <div class="ilDateBox" id="checkDate">--/--/----</div>
                </div>
                <div class="ilLabel heSmall">×ª××¨×™×š</div>
              </div>
            </div>

            <!-- Stamp -->
            <div class="stamp" id="stamp">×××•×©×¨</div>
          </div>

          <!-- MICR strip -->
          <div class="ilMicrStrip">
            <div class="ilMicrLabels">
              <span>CHEQUE No.</span><span>BRANCH No.</span><span>ACCOUNT No.</span>
            </div>
            <div class="ilMicrLine">
              <span class="ilMicrInk">â‘†</span>
              <span id="micrLine">00123   010   12345   4567890   9</span>
              <span class="ilMicrInk">â‘†</span>
            </div>
          </div>
        </div>

        <div class="quip" id="quipText">â€”</div>
      </div>

      <div class="sheetActions">
        <button class="btn secondary" id="recalcBtn">×—×™×©×•×‘ ××—×“×©</button>
        <button class="btn" id="randomBtn">×¨× ×“×•××™×™×–×¨</button>
        <button class="btn danger" id="shareBtn">×©×™×ª×•×£</button>
      </div>
    </div>
  </div>

  <script>
    // --- Constants (exact logic) ---
    const BASE = 200;

    const CLOSENESS_POINTS = {
      "×§×•×œ×’×”": 80,
      "×—×‘×¨×™× ×”×›×™ ×˜×•×‘×™×": 260,
      "×—×‘×¨×™× ×‘××™×“×” ×‘×™× ×•× ×™×ª": 180,
      "×—×‘×¨×™× ×¨×—×•×§×™×": 120,
      "××©×¤×—×” ×§×¨×•×‘×”": 320,
      "××©×¤×—×” ×¨×—×•×§×”": 200,
      "××— ×©×œ ×—×‘×¨ ××• ×—×‘×¨×”": 140,
      "×—×‘×¨×™× ××”×¦×‘×": 220,
    };

    const EVENT_POINTS = {
      "×—×ª×•× ×”": 220,
      "×‘×¨×™×ª/×‘×¨×™×ª×”": 140,
      "×‘×¨/×‘×ª ××¦×•×•×”": 160,
      "×—×™× ×”": 180,
    };

    const LOCATION_POINTS = {
      "××•×œ× ××• ×’×Ÿ ××™×¨×•×¢×™×": 200,
      "××¡×¢×“×”": 140,
      "×‘×™×ª ×›× ×¡×ª": 120,
      "×‘×™×ª ××• ×—×¦×¨": 100,
    };

    const ATTENDEES_MULT = {
      "××’×™×¢ ×œ×‘×“": 1.00,
      "××’×™×¢ ×›×–×•×’": 1.60,
      "×–×•×’ +1": 2.10,
      "×™×•×ª×¨ ×-3 ×× ×©×™×": 2.60,
    };

    const RECIPIENT_BY_EVENT = {
      "×—×ª×•× ×”": "×œ×—×ª×Ÿ ×•×œ×›×œ×”",
      "×‘×¨×™×ª/×‘×¨×™×ª×”": "×œ×”×•×¨×™× ×”×××•×©×¨×™×",
      "×‘×¨/×‘×ª ××¦×•×•×”": "×œ×—×ª×Ÿ/×›×œ×ª ×”×©××—×”",
      "×—×™× ×”": "×œ×–×•×’ ×•×œ××©×¤×—×”",
    };

    const QUIPS = [
      "××‘×œ ×ª×›×œ×¡ ×©× ×™×›× ×™×•×“×¢×™× ×©××™ ××¤×©×¨ ×œ×©×™× ××¡×¤×¨ ×¢×œ ×”×—×‘×¨×•×ª ×©×œ×›×.",
      "×”×‘× ×§ ×¤×—×•×ª ××•×”×‘ ××ª ×–×”, ××‘×œ ×”×œ×‘ ××ª×¢×§×©.",
      "×–×” ×œ× ××“×¢ ××“×•×™×§â€¦ ××‘×œ ×–×” ×›×Ÿ ××§×¡×œ ×‘×¨××©.",
      "×”×—×™×™× ×™×§×¨×™×, ××‘×œ ×’× ××ª× ×× ×©×™× ×˜×•×‘×™×.",
      "×× ×–×” ×”×™×” ×ª×œ×•×™ ×‘×š ×”×™×™×ª ××‘×™×/×” ×’× ×¢×•×’×”. (××‘×œ ×›×¡×£ ×–×” ×¡×‘×‘×”).",
    ];

    // --- State ---
    const state = {
      closeness: null,
      eventType: null,
      location: null,
      attendees: null,
      result: null,
      recipient: null
    };

    // --- Helpers ---
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const roundToNearest10 = (n) => Math.round(n / 10) * 10;
    const formatILS = (n) => `â‚ª${n}`;

    function computeResult({ closeness, eventType, location, attendees }) {
      const subtotal = BASE
        + CLOSENESS_POINTS[closeness]
        + EVENT_POINTS[eventType]
        + LOCATION_POINTS[location];

      const raw = subtotal * ATTENDEES_MULT[attendees];
      const clamped = clamp(raw, 200, 1200);
      const rounded = roundToNearest10(clamped);

      return clamp(rounded, 200, 1200);
    }

    function allSelected() {
      return !!(state.closeness && state.eventType && state.location && state.attendees);
    }

    function currentStepIndex() {
      if (!state.closeness) return 1;
      if (!state.eventType) return 2;
      if (!state.location) return 3;
      if (!state.attendees) return 4;
      return 4;
    }

    function updateProgressUI() {
      const step = currentStepIndex();
      document.getElementById("stepHint").textContent = `×©×œ×‘ ${step} ××ª×•×š 4`;

      const segs = [
        { id:"seg1", done: !!state.closeness },
        { id:"seg2", done: !!state.eventType },
        { id:"seg3", done: !!state.location },
        { id:"seg4", done: !!state.attendees },
      ];
      segs.forEach(s => {
        document.getElementById(s.id).classList.toggle("done", s.done);
      });

      const ready = allSelected();
      document.getElementById("readyHint").textContent = ready ? "××•×›×Ÿ/×” ×œ×—×©×‘ ğŸ‰" : "×‘×—×¨/×™ ×›×“×™ ×œ×”×ª×§×“×";

      const preview = document.getElementById("previewValue");
      const calcBtn = document.getElementById("calcBtn");
      if (ready) {
        const res = computeResult(state);
        preview.textContent = formatILS(res);
        calcBtn.disabled = false;
      } else {
        preview.textContent = "â‚ªâ€”";
        calcBtn.disabled = true;
      }
    }

    function pickRandomQuip() {
      return QUIPS[Math.floor(Math.random() * QUIPS.length)];
    }

    function setTodayDate() {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      document.getElementById("checkDate").textContent = `${dd}/${mm}/${yyyy}`;
    }

    // pseudo â€œamount in wordsâ€ (simple & playful)
    function amountWords(n){
      return `${n} ×©×´×— (×‘×¢×¨×š)`;
    }

    // --- UI rendering for options ---
    function createOptions(containerId, options, stateKey) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      options.forEach(label => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option";
        btn.textContent = label;

        btn.addEventListener("click", () => {
          state[stateKey] = label;

          [...container.querySelectorAll(".option")].forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");

          updateProgressUI();
          autoAdvanceScroll(stateKey);
        });

        container.appendChild(btn);
      });
    }

    function autoAdvanceScroll(stateKey) {
      const mapping = {
        closeness: "step2Card",
        eventType: "step3Card",
        location: "step4Card",
        attendees: null
      };
      const nextId = mapping[stateKey];
      if (!nextId) return;
      const el = document.getElementById(nextId);
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // --- Result overlay + animations ---
    const overlay = document.getElementById("overlay");
    const closeOverlayBtn = document.getElementById("closeOverlay");
    const recipientEl = document.getElementById("recipientText");
    const amountEl = document.getElementById("amountText");
    const amountWordsEl = document.getElementById("amountWords");
    const quipEl = document.getElementById("quipText");
    const stampEl = document.getElementById("stamp");
    const chequeBody = document.getElementById("chequeBody");

    function openOverlay() {
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");

      setTodayDate();

      const result = computeResult(state);
      const recipient = RECIPIENT_BY_EVENT[state.eventType];
      state.result = result;
      state.recipient = recipient;

      // Fill content
      recipientEl.textContent = recipient;
      amountWordsEl.textContent = amountWords(result);
      quipEl.textContent = pickRandomQuip();

      // Restart stamp animation (forces reflow)
      stampEl.style.animation = "none";
      void stampEl.offsetHeight;
      stampEl.style.animation = "";

      // Restart â€œwritingâ€ animation:
      chequeBody.classList.remove("doWrite");
      void chequeBody.offsetHeight;
      chequeBody.classList.add("doWrite");

      // Animate amount counting up
      animateAmount(0, result, 520);

      // Update MICR (purely visual)
      randomizeMicr();
    }

    function closeOverlay() {
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }

    closeOverlayBtn.addEventListener("click", closeOverlay);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeOverlay(); });

    function animateAmount(from, to, durationMs) {
      const start = performance.now();
      const ease = (t) => 1 - Math.pow(1 - t, 3);

      function frame(now) {
        const t = clamp((now - start) / durationMs, 0, 1);
        const v = Math.round(from + (to - from) * ease(t));
        amountEl.textContent = formatILS(v);
        if (t < 1) requestAnimationFrame(frame);
        else amountEl.textContent = formatILS(to);
      }
      requestAnimationFrame(frame);
    }

    function randomizeMicr(){
      const chequeNo = String(Math.floor(10000 + Math.random() * 90000));
      const bank = String(10 + Math.floor(Math.random() * 90)).padStart(3,"0");
      const branch = String(100 + Math.floor(Math.random() * 900)).padStart(3,"0");
      const account = String(1000000 + Math.floor(Math.random() * 9000000));
      const control = String(Math.floor(Math.random() * 9));
      document.getElementById("micrLine").textContent = `${chequeNo}   ${bank}   ${branch}   ${account}   ${control}`;
    }

    // --- Buttons ---
    document.getElementById("calcBtn").addEventListener("click", () => {
      if (!allSelected()) return;
      openOverlay();
    });

    document.getElementById("recalcBtn").addEventListener("click", () => {
      state.closeness = null;
      state.eventType = null;
      state.location = null;
      state.attendees = null;
      state.result = null;
      state.recipient = null;

      ["closenessOptions","eventOptions","locationOptions","attendeesOptions"].forEach(id => {
        document.getElementById(id).querySelectorAll(".option").forEach(el => el.classList.remove("selected"));
      });

      updateProgressUI();
      closeOverlay();
      document.querySelector("header").scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("randomBtn").addEventListener("click", () => {
      if (state.result == null) return;
      const delta = Math.floor(Math.random() * 101) - 50; // [-50..+50]
      const randomized = clamp(state.result + delta, 200, 1200);
      const rounded = roundToNearest10(randomized);
      const finalVal = clamp(rounded, 200, 1200);
      state.result = finalVal;

      quipEl.textContent = pickRandomQuip();
      amountWordsEl.textContent = amountWords(finalVal);

      // restart writing + count-up from current
      chequeBody.classList.remove("doWrite");
      void chequeBody.offsetHeight;
      chequeBody.classList.add("doWrite");

      const currentDisplayed = parseInt((amountEl.textContent || "â‚ª0").replace("â‚ª",""), 10) || 0;
      animateAmount(currentDisplayed, finalVal, 420);
      randomizeMicr();
    });

    async function shareTextFallback() {
      const text = `KamaLasim ××•××¨/×ª: â‚ª${state.result} â€” ${state.recipient}`;
      if (navigator.share) {
        try {
          await navigator.share({ title: "KamaLasim", text });
          return true;
        } catch (e) {}
      }
      try {
        await navigator.clipboard.writeText(text);
        alert("×”×¢×ª×§×ª×™ ×œ×œ×•×— ğŸ“‹");
        return true;
      } catch (e) {
        prompt("×”×¢×ª×§/×™ ××ª ×”×˜×§×¡×˜:", text);
        return true;
      }
    }

    async function shareAsImageIfPossible() {
      const check = document.getElementById("checkCard");
      if (!window.html2canvas) return false;

      const canvas = await html2canvas(check, {
        backgroundColor: null,
        scale: Math.min(2, window.devicePixelRatio || 1),
        useCORS: true,
      });

      return new Promise(async (resolve) => {
        canvas.toBlob(async (blob) => {
          if (!blob) return resolve(false);
          const file = new File([blob], "kamaslasim-check.png", { type: "image/png" });

          if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
            try {
              await navigator.share({
                title: "KamaLasim",
                text: `KamaLasim ××•××¨/×ª: â‚ª${state.result} â€” ${state.recipient}`,
                files: [file],
              });
              return resolve(true);
            } catch (e) {}
          }

          // fallback: download
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "kamaslasim-check.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          alert("×©××ª×™ ×œ×š ×ª××•× ×” ×œ×”×•×¨×“×” â€” ×× ××™×Ÿ ×©×™×ª×•×£ ×ª××•× ×•×ª ×‘××›×©×™×¨, ××¤×©×¨ ×œ×©×ª×£ ××•×ª×” ×™×“× ×™×ª ğŸ™‚");
          resolve(true);
        }, "image/png");
      });
    }

    document.getElementById("shareBtn").addEventListener("click", async () => {
      if (state.result == null) return;
      try {
        const okImg = await shareAsImageIfPossible();
        if (okImg) return;
      } catch (e) {}
      await shareTextFallback();
    });

    // --- Init options ---
    createOptions("closenessOptions", Object.keys(CLOSENESS_POINTS), "closeness");
    createOptions("eventOptions", Object.keys(EVENT_POINTS), "eventType");
    createOptions("locationOptions", Object.keys(LOCATION_POINTS), "location");
    createOptions("attendeesOptions", Object.keys(ATTENDEES_MULT), "attendees");
    updateProgressUI();

    // --- Register Service Worker (optional; safe if file exists) ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
